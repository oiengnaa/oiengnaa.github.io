name: Update and Transform IPTV-10000 List

on:
  schedule:
    # 北京时间每天早上 08:10 运行 (UTC 00:10)
    - cron: '10 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and Transform
      run: |
        # 1. 设置源地址
        SOURCE_URL="https://raw.githubusercontent.com/10000ge10000/iptv-api/refs/heads/master/output/rtp/%E5%B9%BF%E4%B8%9C_%E7%94%B5%E4%BF%A1.m3u"
        
        # 2. 设置代理地址
        PROXY_URL="http://gz.emoni.net:3149/rtp/"

        # 3. 下载并替换文件名改为 tv10000.m3u
        curl -sL "$SOURCE_URL" | sed "s|rtp://|$PROXY_URL|g" > tv10000.m3u
        
        # 4. 检查文件是否为空
        if [ ! -s tv10000.m3u ]; then
          echo "错误：下载失败，文件为空。"
          exit 1
        fi
        
        echo "--- 预览 tv10000.m3u 前 5 行 ---"
        head -n 5 tv10000.m3u

    - name: Commit and Push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # 提交名为 tv10000.m3u 的文件
        git add tv10000.m3u
        
        if git diff --staged --quiet; then
          echo "内容无变化，跳过提交。"
        else
          git commit -m "更新列表: $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
