name: Update and Transform IPTV-wan List

# 触发条件
on:
  schedule:
    # 北京时间每天早上 08:10 运行 (UTC 00:10)
    - cron: '10 0 * * *'
  workflow_dispatch: # 允许手动点击按钮触发

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出你的代码仓库
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 下载源文件并进行转换
    - name: Download and Transform
      run: |
        # 定义源文件地址
        SOURCE_URL="https://raw.githubusercontent.com/Tzwcard/ChinaTelecom-GuangdongIPTV-RTP-List/master/GuangdongIPTV_rtp_all.m3u"
        
        # 定义你的 UDPXY 代理地址
        PROXY_URL="http://gz.emoni.net:3149/rtp/"

        # 下载文件（-sL 保证静默且跟踪重定向），进行替换，保存
        curl -sL "$SOURCE_URL" | sed "s|rtp://|$PROXY_URL|g" > tvwan_list.m3u
        
        # 简单检查：如果文件大小为0，则报错停止，防止推送空文件
        if [ ! -s tvwan_list.m3u ]; then
          echo "Error: Downloaded file is empty!"
          exit 1
        fi

    # 3. 提交更改到你的仓库
    - name: Commit and Push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add tvwan_list.m3u
        # 只有在有变动时才提交，防止 Action 报错
        git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update IPTV list: $(date +'%Y-%m-%d %H:%M:%S')" && git push)
