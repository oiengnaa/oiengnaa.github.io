name: Ultimate Smart Merge IPTV

on:
  schedule:
    - cron: '10 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  merge-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Run Ultimate Merge Script
      run: |
        cat <<EOF > process_m3u.py
        import requests
        import re
        import sys

        SOURCE_URL = "https://raw.githubusercontent.com/Tzwcard/ChinaTelecom-GuangdongIPTV-RTP-List/refs/heads/master/GuangdongIPTV_rtp_all.m3u"
        PROXY_URL = "http://gz.emoni.net:3149/rtp/"
        OUTPUT_FILE = "tv_smart.m3u"

        def clean_channel_name(name):
            try:
                name = str(name).upper()
                # 1. 移除所有括号及内容
                name = re.sub(r'[\(\[（【].*?[\)\]）】]', '', name)
                # 2. 移除关键字
                garbage = ['高清', '标清', '超清', 'HD', 'SD', 'FHD', '4K', '8K', '蓝光', '频道', '电信', 'IPTV', '测试', '备用', '时移', '专用', 'PLUS']
                for word in garbage:
                    name = name.replace(word, '')
                # 3. 规范化 CCTV 格式
                cctv_match = re.search(r'CCTV[- ]?(\d+)', name)
                if cctv_match:
                    name = f"CCTV-{cctv_match.group(1)}"
                # 4. 移除所有特殊符号（只保留中文、英文字母、数字）
                name = re.sub(r'[^\u4e00-\u9fa5A-Z0-9]', '', name)
                return name.strip()
            except:
                return name

        def process_m3u():
            print("正在获取远程文件...")
            try:
                r = requests.get(SOURCE_URL, timeout=30)
                r.encoding = 'utf-8'
                lines = r.text.splitlines()
            except Exception as e:
                print(f"网络请求失败: {e}")
                sys.exit(1)

            channels = {}
            current_meta = None
            
            for line in lines:
                line = line.strip()
                if not line: continue
                if line.startswith("#EXTINF"):
                    current_meta = line
                elif (line.startswith("rtp://") or line.startswith("http")) and current_meta:
                    raw_name = current_meta.split(",")[-1].strip()
                    unified_name = clean_channel_name(raw_name)
                    if not unified_name: unified_name = raw_name

                    new_url = line.replace("rtp://", PROXY_URL)
                    
                    if unified_name not in channels:
                        channels[unified_name] = []
                    channels[unified_name].append(new_url)
                    current_meta = None

            if not channels:
                print("错误：未匹配到任何有效频道数据！")
                sys.exit(1)

            with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                f.write("#EXTM3U\n")
                for name, urls in sorted(channels.items()):
                    for url in urls:
                        f.write(f'#EXTINF:-1 tvg-name="{name}" group-title="SmartMerge",{name}\n')
                        f.write(f"{url}\n")
            
            print(f"处理成功！合并后频道数: {len(channels)}")

        if __name__ == "__main__":
            process_m3u()
        EOF
        
        pip install requests
        python process_m3u.py
        
        # 验证文件是否真的产生了
        if [ -f tv_smart.m3u ]; then
          echo "文件生成成功: tv_smart.m3u"
          ls -lh tv_smart.m3u
        else
          echo "文件生成失败！"
          exit 1
        fi

    - name: Commit and Push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add tv_smart.m3u
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto-fix: smart merge update $(date)"
          git push
        fi
