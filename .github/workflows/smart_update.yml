name: Smart Merge IPTV List (Python)

on:
  schedule:
    # 北京时间每天早上 08:10 运行 (UTC 00:10)
    - cron: '10 0 * * *'
  workflow_dispatch: # 支持手动触发

permissions:
  contents: write

jobs:
  merge-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Run Smart Merge Script
      run: |
        cat <<EOF > process_m3u.py
        import requests
        import re

        # --- 配置区域 ---
        SOURCE_URL = "https://raw.githubusercontent.com/Tzwcard/ChinaTelecom-GuangdongIPTV-RTP-List/refs/heads/master/GuangdongIPTV_rtp_all.m3u"
        PROXY_URL = "http://gz.emoni.net:3149/rtp/"
        OUTPUT_FILE = "tv_smart.m3u"
        # ----------------

        def clean_channel_name(name):
            """
            核心逻辑：清理频道名称中的杂质，使不同线路的名称归于统一
            """
            # 1. 去掉括号、方括号及其内容 (例如: [高清], (1080P))
            name = re.sub(r'[\(\[].*?[\)\]]', '', name)
            # 2. 去掉常见的后缀 (例如: -高清, _4K, HD, SD, 8M, 超清)
            # 使用 IGNORECASE 忽略大小写
            name = re.sub(r'[\s\-_]?(高清|标清|HD|SD|4K|8M|超清|FHD|蓝光)', '', name, flags=re.IGNORECASE)
            # 3. 去掉多余空格
            return name.strip()

        def process_m3u():
            print(f"开始获取源...")
            try:
                response = requests.get(SOURCE_URL, timeout=30)
                response.raise_for_status()
                content = response.text
            except Exception as e:
                print(f"下载失败: {e}")
                exit(1)

            lines = content.splitlines()
            channels = {} # 格式: { "统一后的频道名": [ (原始元数据, 转换后的URL), ... ] }
            current_meta = None
            
            for line in lines:
                line = line.strip()
                if not line: continue
                
                if line.startswith("#EXTINF"):
                    current_meta = line
                elif line.startswith("rtp://") and current_meta:
                    # 提取逗号后的频道原始名称
                    original_name = current_meta.split(",")[-1].strip()
                    # 归一化处理（合并的关键）
                    unified_name = clean_channel_name(original_name)
                    
                    new_url = line.replace("rtp://", PROXY_URL)
                    
                    if unified_name not in channels:
                        channels[unified_name] = []
                    
                    channels[unified_name].append((current_meta, new_url))
                    current_meta = None

            with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                f.write("#EXTM3U\n")
                channel_count = 0
                source_count = 0
                
                # 遍历字典，将同一频道的不同源写在一起
                for name, sources in channels.items():
                    channel_count += 1
                    for meta, url in sources:
                        # 重点：修改 M3U 中的显示名称，使其完全一致
                        # 将 #EXTINF:...,原频道名 改为 #EXTINF:...,统一后的频道名
                        new_meta = re.sub(r',(.*)$', f',{name}', meta)
                        f.write(f"{new_meta}\n")
                        f.write(f"{url}\n")
                        source_count += 1
            
            print(f"处理完成！")
            print(f"原始频道被归纳为: {channel_count} 个唯一频道")
            print(f"总计保留线路: {source_count} 条")

        if __name__ == "__main__":
            process_m3u()
        EOF
        
        pip install requests
        python process_m3u.py

    - name: Commit and Push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add tv_smart.m3u
        
        if git diff --staged --quiet; then
          echo "内容无变化，跳过提交。"
        else
          git commit -m "智能合并频道列表: $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
