name: Smart Merge IPTV List (Python)

# 触发条件：同样设为北京时间 08:15
on:
  schedule:
    - cron: '15 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  merge-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Run Smart Merge Script
      run: |
        # 创建 Python 脚本
        cat <<EOF > process_m3u.py
        import requests
        
        # --- 配置区域 ---
        # 原始链接
        SOURCE_URL = "https://raw.githubusercontent.com/Tzwcard/ChinaTelecom-GuangdongIPTV-RTP-List/refs/heads/master/GuangdongIPTV_rtp_all.m3u"
        # 你的代理地址
        PROXY_URL = "http://gz.emoni.net:3149/rtp/"
        # 输出文件名 (为了不覆盖原来的，这里暂时叫 tv_smart.m3u)
        OUTPUT_FILE = "tv_smart.m3u"
        # ----------------
        
        def process_m3u():
            print(f"正在下载源文件: {SOURCE_URL}...")
            try:
                response = requests.get(SOURCE_URL, timeout=30)
                response.raise_for_status()
                content = response.text
            except Exception as e:
                print(f"下载失败: {e}")
                exit(1)
        
            lines = content.splitlines()
            channels = {}
            current_meta = None
            
            print("正在智能合并同名频道...")
            
            for line in lines:
                line = line.strip()
                if not line:
                    continue
                
                if line.startswith("#EXTINF"):
                    current_meta = line
                elif line.startswith("rtp://") and current_meta:
                    # 提取频道名称 (逗号后的部分)
                    try:
                        # 解析示例: #EXTINF:-1 tvg-name="CCTV1",CCTV-1
                        channel_name = current_meta.split(",")[-1].strip()
                        
                        # 替换 rtp 为代理地址
                        new_url = line.replace("rtp://", PROXY_URL)
                        
                        if channel_name not in channels:
                            channels[channel_name] = []
                        
                        channels[channel_name].append((current_meta, new_url))
                    except:
                        pass
                    current_meta = None 
            
            # 写入文件
            with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                f.write("#EXTM3U\n")
                count = 0
                for name, sources in channels.items():
                    for meta, url in sources:
                        f.write(f"{meta}\n")
                        f.write(f"{url}\n")
                        count += 1
            
            print(f"处理完成! 生成文件: {OUTPUT_FILE}")
            print(f"共合并 {len(channels)} 个频道，包含 {count} 条线路。")

        if __name__ == "__main__":
            process_m3u()
        EOF
        
        # 安装依赖并运行
        pip install requests
        python process_m3u.py
        
        # 预览前5行
        echo "--- 预览新文件 ---"
        head -n 5 tv_smart.m3u

    - name: Commit and Push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # 注意：这里提交的是 tv_smart.m3u
        git add tv_smart.m3u
        
        if git diff --staged --quiet; then
          echo "内容无变化，跳过提交。"
        else
          git commit -m "智能合并更新: $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
